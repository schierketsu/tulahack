<!DOCTYPE html>
<html>
    <head>
        <title>React example @yandex/ymaps3-clusterer</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
        <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
        <script crossorigin src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
        <script src='https://api-maps.yandex.ru/v3/?apikey=%APIKEY%&lang=en_US'></script>
        <script src="common.js"></script>

        <script type="text/babel">
            window.map = null;

            main();
            async function main() {
                const [ymaps3React] = await Promise.all([ymaps3.import('@yandex/ymaps3-reactify'), ymaps3.ready]);
                const reactify = ymaps3React.reactify.bindTo(React, ReactDOM);
                const {
                    YMap,
                    YMapDefaultSchemeLayer,
                    YMapLayer,
                    YMapFeatureDataSource,
                    YMapMarker
                } = reactify.module(ymaps3);

                const {YMapClusterer, clusterByGrid} = reactify.module(await ymaps3.import("@yandex/ymaps3-clusterer"));
                const {useState, useCallback, useMemo} = React;
                const initialPoints = getRandomPoints(100, BOUNDS);
                const gridSizedMethod = clusterByGrid({gridSize: 64})

                function App() {
                    const [clusterer, setClusterer] = useState(true);
                    const [points, setPoints] = useState(() => initialPoints);

                    const updatePoints = useCallback(() => setPoints(getRandomPoints(pointsCount.value || rndNum(), map.bounds)), []);
                    const toggleClusterer = useCallback(() => setClusterer(!clusterer), [clusterer]);

                    const marker = useCallback((feature) => (
                        <YMapMarker
                            key={feature.id}
                            coordinates={feature.geometry.coordinates}
                            source="clusterer-source"
                        >
                            <img src="./pin.svg" className="pin"/>
                        </YMapMarker>
                    ), []);

                    const cluster = useCallback((coordinates, features) => (
                        <YMapMarker
                            key={`${features[0].id}-${features.length}`}
                            coordinates={coordinates}
                            source="clusterer-source"
                        >
                            <div className="circle">
                                <div className="circle-content">
                                    <span className="circle-text">{features.length}</span>
                                </div>
                            </div>
                        </YMapMarker>
                    ), []);


                    return <React.Fragment>
                        <div className="toolbar">
                            <input id="pointsCount" defaultValue="100" placeholder="Count"></input>
                            <button type="button" onClick={updatePoints}>Update points</button>
                            <button type="button" onClick={toggleClusterer}>Delete/Add Clusterer</button>
                        </div>

                        <YMap location={LOCATION} ref={x => map = x}>
                            <YMapDefaultSchemeLayer />
                            <YMapFeatureDataSource id="clusterer-source"/>
                            <YMapLayer source="clusterer-source" type="markers" zIndex={1800}/>
                            {clusterer && <YMapClusterer
                                marker={marker}
                                cluster={cluster}
                                method={gridSizedMethod}
                                features={points}
                            />}
                        </YMap>
                    </React.Fragment>
                }

                const reactRoot = ReactDOM.createRoot(document.getElementById("app"));
                reactRoot.render(<React.StrictMode><App /></React.StrictMode>);
            }
        </script>

        <link rel="stylesheet" href="common.css" />
    </head>
    <body>
        <div id="app"></div>
    </body>
</html>
